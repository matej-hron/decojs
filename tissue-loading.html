<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tissue Loading & Saturation - Deco Theory</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- KaTeX for math formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- App styles -->
    <link rel="stylesheet" href="css/styles.css?v=3">
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">ü´ß Deco Theory</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dive-setup.html">Dive Setup</a></li>
                <li><a href="tissue-loading.html" class="active">Tissue Loading</a></li>
                <li><a href="quiz-physics.html">Quiz: Physics</a></li>
            </ul>
        </div>
    </nav>

    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        ‚ö†Ô∏è <strong>Educational Use Only</strong> ‚Äî This tool is NOT intended for real dive planning. 
        Never use this for actual dives. Always use certified dive computers, tables, and proper training.
    </div>

    <header>
        <h1>ü§ø Tissue Loading & Saturation</h1>
        <p class="subtitle">Visualize how nitrogen saturates and desaturates in your body during a dive</p>
    </header>

    <!-- Dive Profile Header Bar -->
    <div class="profile-header-bar">
        <div class="profile-header-content">
            <div class="profile-header-info">
                <span class="profile-header-label">Current Profile:</span>
                <strong id="profile-header-name">Loading...</strong>
                <span id="profile-header-summary" class="profile-header-summary"></span>
            </div>
            <div class="profile-header-actions">
                <a href="dive-setup.html" class="btn btn-small">‚úèÔ∏è Edit</a>
            </div>
        </div>
    </div>

    <main>
        <!-- Educational Section -->
        <section class="education-section">
            <h2>üìö Understanding Decompression Theory</h2>
            
            <div class="concept-card">
                <h3>Why Does This Matter?</h3>
                <p>
                    When you dive, the increased pressure causes nitrogen from the air you breathe to dissolve 
                    into your body tissues. The deeper you go and the longer you stay, the more nitrogen 
                    accumulates. If you ascend too quickly, this nitrogen can form bubbles in your tissues ‚Äî 
                    causing <strong>decompression sickness (DCS)</strong>, also known as "the bends."
                </p>
            </div>

            <div class="concept-card">
                <h3>Tissue Compartments</h3>
                <p>
                    Your body isn't uniform ‚Äî different tissues absorb and release nitrogen at different rates.
                    Decompression models represent this using <strong>theoretical compartments</strong> ‚Äî these are
                    mathematical constructs fit to experimental data, not literal anatomical tissues:
                </p>
                <ul>
                    <li><strong>Fast compartments</strong> ‚Äî saturate in minutes, but also release gas quickly</li>
                    <li><strong>Medium compartments</strong> ‚Äî take longer to saturate</li>
                    <li><strong>Slow compartments</strong> ‚Äî can take hours to fully saturate</li>
                </ul>
                <p>
                    The B√ºhlmann ZH-L16 model uses <strong>16 theoretical compartments</strong> with half-times 
                    on the order of ~4‚Äì5 to 635 minutes (depending on the specific ZH-L16 variant).
                    The "fast/slow" labels are useful intuition for understanding time constants.
                </p>
            </div>

            <div class="concept-card">
                <h3>The Half-Time Concept</h3>
                <p>
                    A tissue's <strong>half-time</strong> is how long it takes to become 50% saturated (or 50% desaturated) 
                    at a given pressure. After each half-time period:
                </p>
                <div class="half-time-visual">
                    <div class="half-time-bar">
                        <span class="bar-fill" style="width: 50%;">1 half-time: 50%</span>
                    </div>
                    <div class="half-time-bar">
                        <span class="bar-fill" style="width: 75%;">2 half-times: 75%</span>
                    </div>
                    <div class="half-time-bar">
                        <span class="bar-fill" style="width: 87.5%;">3 half-times: 87.5%</span>
                    </div>
                    <div class="half-time-bar">
                        <span class="bar-fill" style="width: 98.4%;">6 half-times: ~98% (saturated)</span>
                    </div>
                </div>
                <p>A 5-minute compartment reaches 50% saturation in 5 minutes; a 635-minute compartment takes over 10 hours!</p>
            </div>

            <details class="learn-more">
                <summary>üî¨ Learn More: The Mathematics</summary>
                <div class="math-content">
                    <h4>Haldane Equation (constant depth)</h4>
                    <p>When staying at a constant depth, tissue pressure changes according to:</p>
                    <div class="formula" id="formula-haldane">
                        P_t(t) = P_{alv} + (P_{t0} - P_{alv}) \cdot e^{-kt}
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">P_t(t)</span> = tissue N‚ÇÇ pressure at time t</li>
                        <li><span class="formula-inline">P_{alv}</span> = inspired (alveolar) N‚ÇÇ pressure</li>
                        <li><span class="formula-inline">P_{t0}</span> = initial tissue N‚ÇÇ pressure</li>
                        <li><span class="formula-inline">k = \frac{\ln(2)}{t_{1/2}}</span> = rate constant</li>
                    </ul>

                    <h4>Schreiner Equation (depth change)</h4>
                    <p>During ascent or descent at a constant rate:</p>
                    <div class="formula" id="formula-schreiner">
                        P_t(t) = P_{alv0} + R \cdot (t - \frac{1}{k}) - (P_{alv0} - P_{t0} - \frac{R}{k}) \cdot e^{-kt}
                    </div>
                    <p>Where <span class="formula-inline">R</span> is the rate of change of alveolar pressure (positive for descent).</p>

                    <h4>Pressure at Depth</h4>
                    <div class="formula" id="formula-pressure">
                        P_{amb} = 1.0 + \frac{depth}{10} \text{ bar}
                    </div>
                    <p>Every 10 meters of seawater adds approximately 1 bar of pressure.</p>
                </div>
            </details>
        </section>

        <!-- Compartment Selection -->
        <section class="compartment-section">
            <h2>üéõÔ∏è Compartment Selection</h2>
            <p>Toggle which tissue compartments to display on the chart:</p>
            
            <div class="compartment-controls">
                <button id="show-all" class="btn btn-small">Show All</button>
                <button id="hide-all" class="btn btn-small">Hide All</button>
                <button id="show-fast" class="btn btn-small">Fast Only</button>
                <button id="show-medium" class="btn btn-small">Medium Only</button>
                <button id="show-slow" class="btn btn-small">Slow Only</button>
            </div>
            
            <div id="compartment-toggles" class="compartment-toggles">
                <!-- Checkboxes added by JavaScript -->
            </div>
        </section>

        <!-- Chart Section -->
        <section class="chart-section">
            <div class="chart-header">
                <h2>üìà Tissue Loading Chart</h2>
                <button id="fullscreen-btn" class="btn btn-small btn-icon" title="Fullscreen">
                    <span class="fullscreen-icon">‚õ∂</span>
                    <span class="fullscreen-text">Fullscreen</span>
                </button>
            </div>
            <div class="chart-container" id="chart-container">
                <canvas id="tissue-chart"></canvas>
                <button id="exit-fullscreen-btn" class="btn btn-fullscreen-close" title="Exit Fullscreen">‚úï</button>
            </div>
            <div class="chart-legend">
                <p><strong>Left axis (N‚ÇÇ Pressure):</strong> Shows nitrogen pressure in each tissue compartment. 
                   Higher values = more nitrogen dissolved.</p>
                <p><strong>Right axis (Depth):</strong> Shows the dive profile (depth increases downward).</p>
                <p><strong>Green dashed line (Alveolar N‚ÇÇ):</strong> The N‚ÇÇ pressure in your lungs ‚Äî this is what 
                   tissues are trying to equilibrate towards. When tissue &lt; alveolar, you're on-gassing; 
                   when tissue &gt; alveolar, you're off-gassing. The crossover is where tissue loading peaks.</p>
                <p><strong>Red dashed line (Ambient Pressure):</strong> The total pressure at current depth. 
                   Bubble risk increases when tissue inert-gas tension exceeds ambient pressure beyond an 
                   allowable gradient (defined by M-values / gradient factors). Some supersaturation is normal 
                   and permitted during controlled ascents.</p>
                <p><strong>Gray dashed line (Surface Saturation):</strong> Equilibrium N‚ÇÇ pressure at surface (~0.74 bar).</p>
            </div>
        </section>

        <!-- Compartment Reference Table -->
        <section class="reference-section">
            <h2>üìã B√ºhlmann ZH-L16A Compartments Reference</h2>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Half-Time</th>
                        <th>Category</th>
                        <th>Tissue Type</th>
                        <th>Time to Saturate*</th>
                    </tr>
                </thead>
                <tbody id="reference-body">
                    <!-- Rows added by JavaScript -->
                </tbody>
            </table>
            <p class="footnote">* Approximate time to reach 98% saturation (6 half-times)</p>
        </section>

        <!-- References Section -->
        <section class="reference-section">
            <h2>üìñ References & Sources</h2>
            <ol class="references-list">
                <li>
                    <strong>Powell, Mark.</strong> 
                    <em>Deco for Divers.</em> 
                    ‚Äî The primary inspiration for this project. An excellent, accessible guide to decompression 
                    theory for recreational and technical divers. Highly recommended!
                </li>
                <li>
                    <strong>B√ºhlmann, A.A.</strong> (1984). 
                    <em>Decompression‚ÄìDecompression Sickness.</em> 
                    Berlin: Springer-Verlag. 
                    ‚Äî The original work describing the ZH-L16 algorithm.
                </li>
                <li>
                    <strong>Wikipedia</strong>. 
                    <a href="https://en.wikipedia.org/wiki/B%C3%BChlmann_decompression_algorithm" target="_blank" rel="noopener">
                        B√ºhlmann decompression algorithm
                    </a> 
                    ‚Äî Overview of the algorithm, tissue compartment half-times, and M-values.
                </li>
                <li>
                    <strong>Wienke, B.R.</strong> 
                    <a href="https://aquatec.wordpress.com/wp-content/uploads/2011/03/decompression-theory.pdf" target="_blank" rel="noopener">
                        Decompression Theory (PDF)
                    </a> 
                    ‚Äî Comprehensive introduction to decompression physics and physiology.
                </li>
                <li>
                    <strong>Alveolar Gas Equation</strong>: 
                    The model accounts for water vapor pressure at body temperature (37¬∞C) = 47 mmHg ‚âà 0.0627 bar, 
                    which reduces the effective partial pressure of inspired gases. 
                    <a href="https://en.wikipedia.org/wiki/Alveolar_gas_equation" target="_blank" rel="noopener">
                        Wikipedia: Alveolar gas equation
                    </a>
                </li>
                <li>
                    <strong>Schreiner, H.R.</strong> (1971). 
                    <em>Safe Limits of Exposure to Increased Pressure.</em> 
                    ‚Äî Derivation of the Schreiner equation for calculating gas loading during linear pressure changes.
                </li>
            </ol>
        </section>
    </main>

    <footer>
        <p>
            <strong>Disclaimer:</strong> This is an educational tool only. Do not use for actual dive planning. 
            Always use certified dive computers and tables, and follow proper training.
        </p>
        <p class="thank-you">
            Special thanks to <strong>Mark Powell</strong> for <em>Deco for Divers</em> ‚Äî the book that made decompression theory click. üìö
        </p>
        <p>
            Based on the B√ºhlmann ZH-L16A decompression algorithm. 
            <a href="https://aquatec.wordpress.com/wp-content/uploads/2011/03/decompression-theory.pdf" target="_blank">Learn more about decompression theory</a>
        </p>
    </footer>

    <!-- Main application script -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
