<!DOCTYPE html>
<html>
<head><title>Test</title></head>
<body>
<pre id="output"></pre>
<script type="module">
import { calculateTissueLoading, getAlveolarN2Pressure, getAmbientPressure } from './js/decoModel.js';

const profile = [
    { time: 0, depth: 0 },
    { time: 2, depth: 40 },
    { time: 22, depth: 40 },
    { time: 26, depth: 9 },
    { time: 29, depth: 9 },
    { time: 30, depth: 6 },
    { time: 35, depth: 6 },
    { time: 36, depth: 3 },
    { time: 41, depth: 3 },
    { time: 42, depth: 0 }
];

const results = calculateTissueLoading(profile, 10);

// Find the peak for compartment 1 (5-min half-time)
const comp1 = results.compartments[1];
let maxPressure = 0;
let maxIndex = 0;

for (let i = 0; i < comp1.pressures.length; i++) {
    if (comp1.pressures[i] > maxPressure) {
        maxPressure = comp1.pressures[i];
        maxIndex = i;
    }
}

const peakTime = results.timePoints[maxIndex];
const peakDepth = results.depthPoints[maxIndex];
const ambientAtPeak = results.ambientPressures[maxIndex];
const alveolarAt40m = getAlveolarN2Pressure(getAmbientPressure(40));

let out = "=== Peak Analysis for Compartment 1 (5-min) ===\n";
out += `Peak time: ${peakTime.toFixed(2)} min\n`;
out += `Peak depth: ${peakDepth.toFixed(2)} m\n`;
out += `Peak tissue pressure: ${maxPressure.toFixed(4)} bar\n`;
out += `Ambient at peak: ${ambientAtPeak.toFixed(4)} bar\n`;
out += `Alveolar N2 at 40m: ${alveolarAt40m.toFixed(4)} bar\n\n`;

// Show values around time 22
// Show values from beginning through time 22
out += "=== Values from t=2 to t=23 ===\n";
for (let i = 0; i < results.timePoints.length; i++) {
    const t = results.timePoints[i];
    if ((t >= 2 && t <= 4) || (t >= 20 && t <= 23)) {
        const alveolarNow = getAlveolarN2Pressure(results.ambientPressures[i]);
        out += `t=${t.toFixed(2)}, depth=${results.depthPoints[i].toFixed(1)}m, tissue=${comp1.pressures[i].toFixed(4)}, alveolar=${alveolarNow.toFixed(4)}, diff=${(alveolarNow - comp1.pressures[i]).toFixed(4)}\n`;
    }
}

document.getElementById('output').textContent = out;
console.log(out);
</script>
</body>
</html>
