<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pressure & Partial Pressure - Deco Theory</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2980b9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Deco Theory">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    
    <!-- KaTeX for math formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- App styles -->
    <link rel="stylesheet" href="css/styles.css?v=6">
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">ü´ß Deco Theory</a>
            <button class="nav-hamburger" aria-label="Toggle menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links">
                <!-- Generated by js/nav.js -->
            </ul>
            <span class="nav-wip-badge">üß™ Experimental</span>
        </div>
    </nav>

    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        ‚ö†Ô∏è <strong>Educational Use Only</strong> ‚Äî This tool is NOT intended for real dive planning. 
        Never use this for actual dives. Always use certified dive computers, tables, and proper training.
    </div>

    <header>
        <h1>üìä Pressure & Partial Pressure</h1>
        <p class="subtitle">Understanding how pressure changes with depth and affects the gases you breathe</p>
    </header>

    <main>
        <!-- Table of Contents -->
        <nav class="toc">
            <h2>üìë Contents</h2>
            <ul>
                <li><a href="#terminology">üìö Dive Profile Terminology</a></li>
                <li><a href="#dive-profile">üìà Your Dive Profile</a></li>
                <li><a href="#total-pressure">üåä Total Pressure Underwater</a></li>
                <li><a href="#gas-consumption">‚õΩ Gas Consumption</a></li>
                <li><a href="#air-composition">üå¨Ô∏è Air Composition</a></li>
                <li><a href="#daltons-law">‚öóÔ∏è Dalton's Law</a></li>
                <li><a href="#partial-pressure-limits">‚ö†Ô∏è Partial Pressure Limits</a></li>
                <li><a href="#end-calculation">üß† Equivalent Narcotic Depth</a></li>
                <li><a href="#oxygen-toxicity">‚ò†Ô∏è Oxygen Toxicity</a></li>
                <li><a href="#partial-pressure-chart">üìä Partial Pressure Chart</a></li>
            </ul>
        </nav>

        <!-- Educational Section -->
        <section id="terminology" class="education-section">
            <h2>üìö Dive Profile Terminology</h2>
            
            <div class="concept-card">
                <h3>Reading a Dive Profile</h3>
                <p>
                    A <strong>dive profile</strong> is a graphical representation of your dive, showing depth over time.
                    Understanding the basic terminology helps you communicate with other divers and interpret 
                    dive computer data effectively.
                </p>
            </div>
        </section>

        <!-- Dive Profile Chart -->
        <section id="dive-profile" class="chart-section">
            <div class="chart-header">
                <h2>üìà Your Dive Profile</h2>
            </div>
            <div id="chart-container" class="chart-wrapper" style="height: 600px;"></div>
            
            <!-- Terminology Legend -->
            <div class="terminology-legend">
                <h3>üìñ Key Terms</h3>
                <div class="term-grid">
                    <div class="term-item">
                        <span class="term-marker descent"></span>
                        <div class="term-content">
                            <strong>Descent</strong>
                            <span>The phase from leaving the surface until reaching your planned depth. Recommended rate: ‚â§18-20 m/min.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker bottom-time"></span>
                        <div class="term-content">
                            <strong>Bottom Time</strong>
                            <span>Total time from beginning of descent to start of final ascent. Includes descent phase.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker max-depth"></span>
                        <div class="term-content">
                            <strong>Maximum Depth</strong>
                            <span>The deepest point reached during the dive. Determines ambient pressure and gas absorption rate.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker ascent"></span>
                        <div class="term-content">
                            <strong>Ascent</strong>
                            <span>Return to surface. Rate should not exceed 9-10 m/min to prevent bubble formation.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker deco-stop"></span>
                        <div class="term-content">
                            <strong>Deco Stop</strong>
                            <span>Mandatory pause at specific depth during ascent to allow safe elimination of inert gases.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker safety-stop"></span>
                        <div class="term-content">
                            <strong>Safety Stop</strong>
                            <span>Voluntary 3-minute pause at 3-5m during ascent to allow excess nitrogen to off-gas safely.</span>
                        </div>
                    </div>
                    <div class="term-item">
                        <span class="term-marker surface-interval"></span>
                        <div class="term-content">
                            <strong>Surface Interval (SI)</strong>
                            <span>Time spent at surface between dives to off-gas nitrogen. Longer SI = more nitrogen eliminated.</span>
                        </div>
                    </div>
                </div>
            </div>
            <a id="profile-sandbox-link" href="sandbox/" class="sandbox-link" target="_blank">
                üî¨ Open in Sandbox ‚Üí
            </a>
        </section>

        <!-- Total Pressure Section -->
        <section id="total-pressure" class="education-section">
            <h2>üåä Total Pressure Underwater</h2>
            
            <div class="concept-card">
                <h3>What Creates Pressure Underwater?</h3>
                <p>
                    The total pressure a diver experiences underwater comes from two sources:
                </p>
                <ul>
                    <li><strong>Atmospheric pressure</strong> ‚Äî The weight of the air column above you. At sea level, this is approximately <strong>1 bar</strong> (1 atm = 1.01325 bar).</li>
                    <li><strong>Hydrostatic pressure</strong> ‚Äî The weight of the water column above you. In seawater, this adds approximately <strong>1 bar per 10 meters</strong> of depth.</li>
                </ul>
                <p>
                    Therefore, at 10m depth you experience 2 bar total pressure (1 atm + 1 bar water), 
                    at 20m it's 3 bar, at 30m it's 4 bar, and so on.
                </p>
            </div>

            <details class="learn-more">
                <summary>üìç Atmospheric Pressure at Different Altitudes</summary>
                <div class="math-content">
                    <p>Atmospheric pressure decreases with altitude. If you dive in a mountain lake, you start with less than 1 bar at the surface:</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Altitude</th>
                                <th>Pressure (bar)</th>
                                <th>Example Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sea level</td>
                                <td>1.013</td>
                                <td>Ocean, coastal lakes</td>
                            </tr>
                            <tr>
                                <td>300 m</td>
                                <td>0.977</td>
                                <td>Low hills</td>
                            </tr>
                            <tr>
                                <td>700 m</td>
                                <td>0.932</td>
                                <td>Mountain lakes</td>
                            </tr>
                            <tr>
                                <td>1500 m</td>
                                <td>0.845</td>
                                <td>High altitude lakes</td>
                            </tr>
                            <tr>
                                <td>2500 m</td>
                                <td>0.747</td>
                                <td>Lake Titicaca</td>
                            </tr>
                            <tr>
                                <td>3000 m</td>
                                <td>0.701</td>
                                <td>Extreme altitude diving</td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="note">‚ö†Ô∏è Altitude diving requires special procedures and decompression adjustments.</p>
                </div>
            </details>

            <details class="learn-more">
                <summary>üî¨ Mathematical Formulas</summary>
                <div class="math-content">
                    <h4>Total Ambient Pressure</h4>
                    <p>The total pressure at any depth is the sum of atmospheric and hydrostatic pressure:</p>
                    <div class="formula" id="formula-total-pressure">
                        P_{amb} = P_{atm} + P_{hydro} = P_{atm} + \rho \cdot g \cdot h
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">P_{amb}</span> = total ambient pressure</li>
                        <li><span class="formula-inline">P_{atm}</span> = atmospheric pressure (‚âà1 bar at sea level)</li>
                        <li><span class="formula-inline">\rho</span> = water density (‚âà1025 kg/m¬≥ for seawater)</li>
                        <li><span class="formula-inline">g</span> = gravitational acceleration (9.81 m/s¬≤)</li>
                        <li><span class="formula-inline">h</span> = depth in meters</li>
                    </ul>

                    <h4>Simplified Formula (Sea Level)</h4>
                    <p>For diving at sea level, we use the simplified formula:</p>
                    <div class="formula" id="formula-simplified-pressure">
                        P_{amb} = 1 + \frac{depth}{10} \text{ bar}
                    </div>
                    <p>This approximation works well for recreational diving calculations.</p>

                    <h4>Atmospheric Pressure vs Altitude</h4>
                    <p>Atmospheric pressure decreases exponentially with altitude:</p>
                    <div class="formula" id="formula-altitude-pressure">
                        P_{atm}(h) = P_0 \cdot e^{-\frac{h}{H}}
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">P_0</span> = 1.01325 bar (sea level pressure)</li>
                        <li><span class="formula-inline">h</span> = altitude in meters</li>
                        <li><span class="formula-inline">H</span> ‚âà 8500 m (scale height of atmosphere)</li>
                    </ul>
                </div>
            </details>
        </section>

        <!-- Total Pressure Chart Section -->
        <section id="pressure-chart" class="chart-section">
            <div class="chart-header">
                <h2>üìà Dive Profile with Total Pressure</h2>
            </div>
            <div id="pressure-chart-container" class="chart-wrapper" style="height: 600px;"></div>
            <a id="pressure-sandbox-link" href="sandbox/" class="sandbox-link" target="_blank">
                üî¨ Open in Sandbox ‚Üí
            </a>
        </section>

        <!-- Gas Consumption Section -->
        <section id="gas-consumption" class="education-section">
            <h2>‚õΩ Gas Consumption</h2>
            
            <div class="concept-card">
                <h3>Why Depth Matters for Gas Supply</h3>
                <p>
                    According to <strong>Boyle-Mariotte's Law</strong>, as pressure increases, the volume of gas decreases proportionally. 
                    Underwater, this means you breathe <em>compressed</em> air from your tank. At 10m depth (2 bar), 
                    each breath draws twice the amount of gas molecules compared to the surface.
                </p>
                <p>
                    This is why deeper dives consume your gas supply faster‚Äîyou're breathing the same volume of air, 
                    but it contains more gas molecules due to compression.
                </p>
            </div>

            <div class="concept-card">
                <h3>Surface Air Consumption (SAC)</h3>
                <p>
                    <strong>SAC rate</strong> (also called RMV - Respiratory Minute Volume) is how much gas you breathe 
                    per minute at the surface. For planning purposes, we use a typical value of <strong>20 L/min</strong> 
                    for relaxed diving, though actual consumption varies based on exertion, stress, and individual factors.
                </p>
                <p>
                    At depth, your actual consumption is: <strong>SAC √ó Ambient Pressure</strong>
                </p>
                <ul>
                    <li>Surface (1 bar): 20 L/min</li>
                    <li>10m (2 bar): 40 L/min</li>
                    <li>20m (3 bar): 60 L/min</li>
                    <li>30m (4 bar): 80 L/min</li>
                    <li>40m (5 bar): 100 L/min</li>
                </ul>
            </div>

            <details class="learn-more">
                <summary>üî¨ Gas Consumption Formula</summary>
                <div class="math-content">
                    <h4>Gas Consumed at Depth</h4>
                    <p>The gas consumption at any depth can be calculated as:</p>
                    <div class="formula" id="formula-gas-consumption">
                        \text{Consumption} = SAC \times P_{amb} \times t
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">SAC</span> = Surface Air Consumption (L/min at surface)</li>
                        <li><span class="formula-inline">P_{amb}</span> = Ambient pressure in bar (1 + depth/10)</li>
                        <li><span class="formula-inline">t</span> = Time at depth (minutes)</li>
                    </ul>

                    <h4>Available Gas in Cylinder</h4>
                    <div class="formula" id="formula-gas-available">
                        \text{Gas Available} = V_{cylinder} \times (P_{start} - P_{reserve})
                    </div>
                    <p>For a 12L cylinder at 200 bar with 50 bar reserve:</p>
                    <p>Available gas = 12 √ó (200 - 50) = <strong>1800 liters</strong></p>
                </div>
            </details>
        </section>

        <!-- Gas Consumption Chart Section -->
        <section id="gas-consumption-chart" class="chart-section">
            <div class="chart-header">
                <h2>üìà Gas Consumption During Dive</h2>
            </div>
            
            <div id="gas-chart-container" class="chart-wrapper" style="height: 600px;"></div>
            
            <div id="gas-summary-container" class="gas-summary"></div>
            
            <a id="gas-sandbox-link" href="sandbox/" class="sandbox-link" target="_blank">
                üî¨ Open in Sandbox ‚Üí
            </a>
        </section>

        <!-- Air Composition Section -->
        <section id="air-composition" class="education-section">
            <h2>üå¨Ô∏è Air Composition</h2>
            
            <div class="concept-card">
                <h3>What's in the Air You Breathe?</h3>
                <p>
                    The air we breathe is a mixture of gases. Understanding this composition is fundamental 
                    to diving because each gas behaves differently under pressure. The main components are:
                </p>
                <ul>
                    <li><strong>Nitrogen (N‚ÇÇ)</strong> ‚Äî 78% ‚Äî inert gas, does not participate in metabolism</li>
                    <li><strong>Oxygen (O‚ÇÇ)</strong> ‚Äî 21% ‚Äî essential for life, but toxic at high partial pressures</li>
                    <li><strong>Other gases</strong> ‚Äî 1% ‚Äî primarily Argon, CO‚ÇÇ, and trace gases</li>
                </ul>
            </div>

            <div class="chart-container-small">
                <canvas id="air-composition-chart"></canvas>
            </div>

            <div class="concept-card">
                <h3>Breathing Gas Mixtures</h3>
                <p>
                    Divers often use modified gas mixtures to extend bottom time or reduce narcosis:
                </p>
                <ul>
                    <li><strong>Nitrox (EAN)</strong> ‚Äî Enriched Air Nitrox, oxygen 22-40%, rest nitrogen. Reduces nitrogen loading.</li>
                    <li><strong>Trimix</strong> ‚Äî Oxygen, nitrogen, and helium. Helium reduces narcosis at depth.</li>
                    <li><strong>Heliox</strong> ‚Äî Oxygen and helium only. Used for very deep dives.</li>
                </ul>
            </div>
        </section>

        <!-- Dalton's Law Section -->
        <section id="daltons-law" class="education-section">
            <h2>‚öóÔ∏è Dalton's Law of Partial Pressures</h2>
            
            <div class="concept-card">
                <h3>The Foundation of Dive Gas Physics</h3>
                <p>
                    <strong>Dalton's Law</strong> states that the total pressure of a gas mixture equals 
                    the sum of the partial pressures of each component gas. The <em>partial pressure</em> 
                    of a gas is the pressure it would exert if it occupied the same volume alone.
                </p>
            </div>

            <details class="learn-more" open>
                <summary>üî¨ Dalton's Law Formula</summary>
                <div class="math-content">
                    <h4>Total Pressure</h4>
                    <div class="formula" id="formula-dalton-total">
                        P_{total} = P_{O_2} + P_{N_2} + P_{He} + \ldots
                    </div>
                    
                    <h4>Partial Pressure Calculation</h4>
                    <div class="formula" id="formula-partial-pressure">
                        pp_x = f_x \times P_{amb}
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">pp_x</span> = partial pressure of gas x (bar)</li>
                        <li><span class="formula-inline">f_x</span> = fraction of gas x in the mixture (decimal, e.g., 0.21 for 21%)</li>
                        <li><span class="formula-inline">P_{amb}</span> = ambient pressure (bar), calculated as 1 + depth/10</li>
                    </ul>
                </div>
            </details>

            <div class="concept-card">
                <h3>Example: Air at 30 Meters</h3>
                <p>At 30 meters, the ambient pressure is <strong>4 bar</strong> (1 + 30/10). For air:</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Gas</th>
                            <th>Fraction</th>
                            <th>Calculation</th>
                            <th>Partial Pressure</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>O‚ÇÇ</td>
                            <td>0.21</td>
                            <td>0.21 √ó 4</td>
                            <td><strong>0.84 bar</strong></td>
                        </tr>
                        <tr>
                            <td>N‚ÇÇ</td>
                            <td>0.79</td>
                            <td>0.79 √ó 4</td>
                            <td><strong>3.16 bar</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Partial Pressure Limits Section -->
        <section id="partial-pressure-limits" class="education-section">
            <h2>‚ö†Ô∏è Partial Pressure Limits</h2>
            
            <div class="concept-card warning-card">
                <h3>üî¥ Oxygen Limits (ppO‚ÇÇ)</h3>
                <p>
                    Oxygen becomes toxic at elevated partial pressures. The body responds differently 
                    to various ppO‚ÇÇ levels:
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ppO‚ÇÇ (bar)</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="danger-row">
                            <td>&lt; 0.16</td>
                            <td>‚ö´ Hypoxia</td>
                            <td>Loss of consciousness, death. Minimum for survival.</td>
                        </tr>
                        <tr class="safe-row">
                            <td>0.16 ‚Äì 0.50</td>
                            <td>üü¢ Normal</td>
                            <td>Surface breathing range.</td>
                        </tr>
                        <tr class="safe-row">
                            <td>0.50 ‚Äì 1.40</td>
                            <td>üü¢ Safe for diving</td>
                            <td>Recommended working limit for recreational diving.</td>
                        </tr>
                        <tr class="warning-row">
                            <td>1.40 ‚Äì 1.60</td>
                            <td>üü° Caution</td>
                            <td>Acceptable for decompression stops only. Limited exposure time.</td>
                        </tr>
                        <tr class="danger-row">
                            <td>&gt; 1.60</td>
                            <td>üî¥ Danger</td>
                            <td>High risk of CNS oxygen toxicity (seizures).</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="concept-card">
                <h3>Maximum Operating Depth (MOD)</h3>
                <p>
                    The MOD is the deepest you can safely dive with a specific gas mix without exceeding 
                    the ppO‚ÇÇ limit. It's calculated from the oxygen fraction and desired maximum ppO‚ÇÇ.
                </p>
                <details class="learn-more" open>
                    <summary>üî¨ MOD Formula</summary>
                    <div class="math-content">
                        <div class="formula" id="formula-mod">
                            MOD = \left(\frac{ppO_{2,max}}{f_{O_2}} - 1\right) \times 10
                        </div>
                        <p>Where:</p>
                        <ul>
                            <li><span class="formula-inline">ppO_{2,max}</span> = maximum allowed partial pressure (typically 1.4 bar)</li>
                            <li><span class="formula-inline">f_{O_2}</span> = oxygen fraction in the gas (decimal)</li>
                        </ul>
                        <p><strong>Example:</strong> For EAN32 (32% O‚ÇÇ) with ppO‚ÇÇ limit of 1.4 bar:</p>
                        <p>MOD = ((1.4 / 0.32) - 1) √ó 10 = <strong>33.75m</strong></p>
                    </div>
                </details>
            </div>

            <div class="concept-card warning-card">
                <h3>üü° Nitrogen Limits (ppN‚ÇÇ) ‚Äî Narcosis</h3>
                <p>
                    Nitrogen becomes narcotic at elevated partial pressures, causing impaired judgment, 
                    euphoria, and slowed reactions‚Äîsimilar to alcohol intoxication.
                </p>
                
                <div class="highlight-box">
                    <h4>üç∏ The "Martini Rule"</h4>
                    <p>
                        A popular rule of thumb: every 10 meters of depth on air is roughly equivalent 
                        to drinking one martini on an empty stomach. At 30m, you might feel like 
                        you've had 3 martinis!
                    </p>
                    <ul>
                        <li>10m ‚Äî 1 martini</li>
                        <li>20m ‚Äî 2 martinis</li>
                        <li>30m ‚Äî 3 martinis</li>
                        <li>40m ‚Äî 4 martinis</li>
                    </ul>
                    <p><em>Note: Individual susceptibility varies greatly. Some divers feel effects 
                    earlier, others later. Cold, stress, and fatigue increase narcosis.</em></p>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ppN‚ÇÇ (bar)</th>
                            <th>Equivalent Depth (Air)</th>
                            <th>Effects</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="safe-row">
                            <td>&lt; 2.4</td>
                            <td>&lt; 20m</td>
                            <td>Minimal effects for most divers.</td>
                        </tr>
                        <tr class="warning-row">
                            <td>2.4 ‚Äì 3.2</td>
                            <td>20 ‚Äì 30m</td>
                            <td>Mild euphoria, slight impairment.</td>
                        </tr>
                        <tr class="warning-row">
                            <td>3.2 ‚Äì 4.0</td>
                            <td>30 ‚Äì 40m</td>
                            <td>Noticeable impairment, reduced judgment.</td>
                        </tr>
                        <tr class="danger-row">
                            <td>&gt; 4.0</td>
                            <td>&gt; 40m</td>
                            <td>Severe narcosis. Maximum limit for recreational diving.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- END Calculation Section -->
        <section id="end-calculation" class="education-section">
            <h2>üß† Equivalent Narcotic Depth (END)</h2>
            
            <div class="concept-card">
                <h3>Why END Matters</h3>
                <p>
                    When diving with helium-based gases (Trimix, Heliox), helium replaces some nitrogen 
                    and oxygen. Since helium is <em>not</em> narcotic, the narcotic effect is reduced 
                    compared to air at the same depth.
                </p>
                <p>
                    <strong>END</strong> tells you the depth at which you would experience the same 
                    narcotic effect if breathing air. It's a way to compare narcotic load across 
                    different gas mixtures.
                </p>
            </div>

            <details class="learn-more" open>
                <summary>üî¨ END Formula</summary>
                <div class="math-content">
                    <div class="formula" id="formula-end">
                        END = (D + 10) \times (1 - f_{He}) - 10
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li><span class="formula-inline">D</span> = actual depth in meters</li>
                        <li><span class="formula-inline">f_{He}</span> = fraction of helium in the gas (decimal)</li>
                        <li>The formula assumes O‚ÇÇ is also narcotic (conservative approach)</li>
                    </ul>
                    
                    <h4>Example: TX 18/45 at 60 meters</h4>
                    <p>Trimix with 18% O‚ÇÇ, 45% He (therefore 37% N‚ÇÇ):</p>
                    <p>END = (60 + 10) √ó (1 - 0.45) - 10 = 70 √ó 0.55 - 10 = <strong>28.5m</strong></p>
                    <p>So at 60m on this Trimix, you'd feel like you're at ~29m on air!</p>
                </div>
            </details>

            <div class="concept-card">
                <h3>END Examples for Common Gases</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Depth</th>
                            <th>Air (0% He)</th>
                            <th>TX 21/35</th>
                            <th>TX 18/45</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>40m</td>
                            <td>40m</td>
                            <td>22.5m</td>
                            <td>17.5m</td>
                        </tr>
                        <tr>
                            <td>50m</td>
                            <td>50m</td>
                            <td>29m</td>
                            <td>23m</td>
                        </tr>
                        <tr>
                            <td>60m</td>
                            <td>60m</td>
                            <td>35.5m</td>
                            <td>28.5m</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Oxygen Toxicity Section -->
        <section id="oxygen-toxicity" class="education-section">
            <h2>‚ò†Ô∏è Oxygen Toxicity</h2>
            
            <div class="concept-card warning-card">
                <h3>Two Types of Oxygen Toxicity</h3>
                <p>
                    Breathing oxygen at elevated partial pressures can cause two distinct types of toxicity:
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Cause</th>
                            <th>Symptoms</th>
                            <th>Diving Relevance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="danger-row">
                            <td><strong>CNS Toxicity</strong></td>
                            <td>High ppO‚ÇÇ (&gt;1.6 bar)</td>
                            <td>Seizures, convulsions, tunnel vision, twitching</td>
                            <td>Immediate danger, can cause drowning</td>
                        </tr>
                        <tr class="warning-row">
                            <td><strong>Pulmonary Toxicity</strong></td>
                            <td>Prolonged exposure (ppO‚ÇÇ &gt;0.5 bar)</td>
                            <td>Chest pain, coughing, breathing difficulty</td>
                            <td>Relevant for long exposures, rebreathers</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="concept-card collapsible" id="cns-otu-section">
                <div class="collapsible-header">
                    <h3>üìä CNS & OTU Tracking</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="cns-tracking-toggle">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Show Details</span>
                    </label>
                </div>
                
                <div class="collapsible-content" id="cns-otu-content" style="display: none;">
                    <p>
                        <em>‚ö†Ô∏è This is advanced content. For recreational diving, simply staying below 
                        1.4 bar ppO‚ÇÇ is sufficient. CNS/OTU tracking is primarily used in technical 
                        diving with extended oxygen exposures.</em>
                    </p>
                    
                    <h4>CNS (Central Nervous System) Clock</h4>
                    <p>
                        The CNS clock tracks your exposure as a percentage of the maximum allowable 
                        time at each ppO‚ÇÇ level. At 100%, you've reached the recommended limit.
                    </p>
                    <table class="data-table small-table">
                        <thead>
                            <tr>
                                <th>ppO‚ÇÇ (bar)</th>
                                <th>NOAA Max Time</th>
                                <th>CNS% per min</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>1.60</td><td>45 min</td><td>2.22%</td></tr>
                            <tr><td>1.55</td><td>83 min</td><td>1.20%</td></tr>
                            <tr><td>1.50</td><td>120 min</td><td>0.83%</td></tr>
                            <tr><td>1.45</td><td>135 min</td><td>0.74%</td></tr>
                            <tr><td>1.40</td><td>150 min</td><td>0.67%</td></tr>
                            <tr><td>1.35</td><td>165 min</td><td>0.61%</td></tr>
                            <tr><td>1.30</td><td>180 min</td><td>0.56%</td></tr>
                            <tr><td>1.20</td><td>210 min</td><td>0.48%</td></tr>
                            <tr><td>1.10</td><td>240 min</td><td>0.42%</td></tr>
                        </tbody>
                    </table>
                    
                    <h4>OTU (Oxygen Tolerance Units)</h4>
                    <p>
                        OTU tracks cumulative pulmonary (lung) oxygen exposure. The formula applies 
                        when ppO‚ÇÇ exceeds 0.5 bar:
                    </p>
                    <div class="formula" id="formula-otu">
                        OTU = t \times \left(\frac{ppO_2 - 0.5}{0.5}\right)^{0.83}
                    </div>
                    <p>Daily limits: <strong>300 OTU</strong> (single dive), <strong>850 OTU</strong> (total daily)</p>
                </div>
            </div>

            <div class="concept-card">
                <h3>Symptoms of CNS Oxygen Toxicity</h3>
                <p>Remember the mnemonic <strong>VENTID-C</strong>:</p>
                <ul>
                    <li><strong>V</strong>isual disturbances (tunnel vision)</li>
                    <li><strong>E</strong>ar ringing (tinnitus)</li>
                    <li><strong>N</strong>ausea</li>
                    <li><strong>T</strong>witching (especially facial muscles)</li>
                    <li><strong>I</strong>rritability, anxiety</li>
                    <li><strong>D</strong>izziness</li>
                    <li><strong>C</strong>onvulsions (the most dangerous)</li>
                </ul>
                <p class="warning-text">
                    ‚ö†Ô∏è If you experience any of these symptoms, immediately signal your buddy and 
                    begin ascending. Underwater convulsions are often fatal.
                </p>
            </div>
        </section>

        <!-- Partial Pressure Chart Section -->
        <section id="partial-pressure-chart" class="chart-section">
            <div class="chart-header">
                <h2>üìä Partial Pressures During Dive</h2>
            </div>
            
            <div id="pp-chart-container" class="chart-wrapper" style="height: 600px;"></div>
            
            <a id="pp-sandbox-link" href="sandbox/" class="sandbox-link" target="_blank">
                üî¨ Open in Sandbox ‚Üí
            </a>
        </section>
    </main>

    <footer>
        <p>Educational visualization only. Not for dive planning.</p>
        <span class="version-number"></span>
    </footer>

    <script type="module">
        import { DiveProfileChart } from './js/charts/DiveProfileChart.js';
        import { generateDecoProfile, getDiveSetupWaypoints } from './js/diveSetup.js';
        import { getAmbientPressure, SURFACE_PRESSURE } from './js/decoModel.js';
        import { getSandboxUrl } from './js/urlParams.js';
        
        // =====================================================================
        // DIVE PROFILE DEFINITIONS FOR THIS PAGE
        // =====================================================================
        
        // Define gases for the deco profile
        const DECO_GASES = [
            { id: 'air', name: 'Air', o2: 0.21, n2: 0.79, he: 0, cylinderVolume: 18, startPressure: 200 }
        ];
        
        // Generate the deco profile (20m/40min with GF 50/80 creates deco stops)
        const decoResult = generateDecoProfile(20, 40, DECO_GASES, 50, 80);
        
        /**
         * Default profile for terminology/pressure/consumption charts
         */
        const DECO_PROFILE = {
            id: 'deco-20m-40min',
            name: '20m Deco Dive',
            description: 'A 20m dive for 40 minutes with conservative GF 50/80',
            gases: DECO_GASES,
            gfLow: 50,
            gfHigh: 80,
            surfaceInterval: 0.1,
            dives: [{
                waypoints: decoResult.waypoints
            }]
        };
        
        /**
         * Multi-gas profile for partial pressure demonstration
         */
        const MULTIGAS_GASES = [
            { id: 'air', name: 'Air', o2: 0.21, n2: 0.79, he: 0, cylinderVolume: 18, startPressure: 200 }
        ];
        
        const MULTIGAS_PROFILE = {
            id: 'multigas-30m',
            name: '30m Multi-Gas Dive',
            description: 'A 30m dive with EAN50 deco gas',
            gases: MULTIGAS_GASES,
            gfLow: 50,
            gfHigh: 80,
            surfaceInterval: 0.1,
            dives: [{
                waypoints: [
                    { time: 0, depth: 0, gasId: 'air'  },
                    { time: 2, depth: 30, gasId: 'air' },
                    { time: 25, depth: 30, gasId: 'air'  },
                    { time: 28, depth: 6, gasId: 'air'  },
                    { time: 34, depth: 6, gasId: 'air'  },
                    { time: 35, depth: 3, gasId: 'air'  },
                    { time: 38, depth: 3, gasId: 'air'  },
                    { time: 39, depth: 0, gasId: 'air'  }
                ]
            }]
        };
        
        // =====================================================================
        // CHART INSTANCES
        // =====================================================================
        
        // 1. Dive Profile Chart (terminology section) - depth variant
        const profileChart = new DiveProfileChart(
            document.getElementById('chart-container'),
            {
                diveSetup: DECO_PROFILE,
                options: {
                    mode: 'depth',
                    showLabels: true,
                    showGasSwitches: true,
                    showDecoStops: true,
                    showCeiling: true,
                    fullscreenButton: true
                }
            }
        );
        
        // 2. Total Pressure Chart - pressure variant
        const pressureChart = new DiveProfileChart(
            document.getElementById('pressure-chart-container'),
            {
                diveSetup: DECO_PROFILE,
                options: {
                    mode: 'depth',
                    showLabels: false,
                    showGasSwitches: false,
                    showDecoStops: false,
                    showAmbientPressure: true,
                    fullscreenButton: true
                }
            }
        );
        
        // 3. Gas Consumption Chart - gas variant
        const gasChart = new DiveProfileChart(
            document.getElementById('gas-chart-container'),
            {
                diveSetup: DECO_PROFILE,
                options: {
                    mode: 'depth',
                    showLabels: false,
                    showGasSwitches: true,
                    showDecoStops: false,
                    showGasConsumption: true,
                    fullscreenButton: true
                }
            }
        );
        
        // Render gas summary for the consumption chart
        function renderGasSummary(container, gasSummary, reservePressure = 50) {
            if (!gasSummary.tanks.length) {
                container.innerHTML = '';
                return;
            }
            
            const tankRows = gasSummary.tanks.map(tank => {
                const status = tank.endPressure < 0 ? 'critical' :
                               tank.endPressure < reservePressure ? 'critical' :
                               tank.endPressure < reservePressure * 1.3 ? 'warning' : 'ok';
                return `
                    <div class="gas-tank-row">
                        <span class="gas-tank-name">${tank.name}</span>
                        <span class="gas-tank-stats">
                            <span>${tank.startPressure} ‚Üí <span class="${status}">${tank.endPressure} bar</span></span>
                            <span>(${tank.consumed}L used)</span>
                        </span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <h4>‚õΩ Gas Summary</h4>
                ${tankRows}
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                    Total: ${Math.round(gasSummary.totalConsumed)}L consumed
                </div>
            `;
        }
        
        const gasSummaryContainer = document.getElementById('gas-summary-container');
        if (gasSummaryContainer) {
            const waypoints = getDiveSetupWaypoints(DECO_PROFILE);
            const gases = DECO_PROFILE.gases || [];
            const sacRate = 20; // L/min at surface
            
            // Calculate gas consumption
            const tankConsumption = new Map();
            gases.forEach(gas => {
                tankConsumption.set(gas.id, {
                    name: gas.name || `${(gas.o2 * 100).toFixed(0)}%`,
                    startPressure: gas.startPressure || 200,
                    cylinderVolume: gas.cylinderVolume || 12,
                    consumed: 0
                });
            });
            
            let currentGasId = gases[0]?.id || null;
            for (let i = 1; i < waypoints.length; i++) {
                const wp = waypoints[i];
                const prevWp = waypoints[i - 1];
                
                if (wp.gasId) currentGasId = wp.gasId;
                
                const tank = tankConsumption.get(currentGasId);
                if (!tank) continue;
                
                const avgDepth = (wp.depth + prevWp.depth) / 2;
                const duration = wp.time - prevWp.time;
                const avgPressure = getAmbientPressure(avgDepth) / SURFACE_PRESSURE;
                tank.consumed += sacRate * avgPressure * duration;
            }
            
            const gasSummary = { tanks: [], totalConsumed: 0 };
            tankConsumption.forEach((tank, gasId) => {
                const totalLiters = tank.startPressure * tank.cylinderVolume;
                const remainingLiters = totalLiters - tank.consumed;
                const endPressure = Math.max(0, remainingLiters / tank.cylinderVolume);
                
                gasSummary.tanks.push({
                    name: tank.name,
                    startPressure: tank.startPressure,
                    endPressure: Math.round(endPressure),
                    consumed: Math.round(tank.consumed)
                });
                gasSummary.totalConsumed += tank.consumed;
            });
            
            renderGasSummary(gasSummaryContainer, gasSummary);
        }
        
        // 4. Partial Pressure Chart - partial pressure variant
        const ppChart = new DiveProfileChart(
            document.getElementById('pp-chart-container'),
            {
                diveSetup: DECO_PROFILE,
                options: {
                    mode: 'depth',
                    showLabels: false,
                    showGasSwitches: true,
                    showDecoStops: false,
                    showPartialPressures: true,
                    fullscreenButton: true
                }
            }
        );
        
        // =====================================================================
        // AIR COMPOSITION CHART (standalone - not a dive profile variant)
        // =====================================================================
        
        const airCanvas = document.getElementById('air-composition-chart');
        if (airCanvas && typeof Chart !== 'undefined') {
            new Chart(airCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Nitrogen (N‚ÇÇ)', 'Oxygen (O‚ÇÇ)', 'Other gases'],
                    datasets: [{
                        data: [78, 21, 1],
                        backgroundColor: ['#3498db', '#2ecc71', '#95a5a6'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 14 }, padding: 20 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${ctx.raw}%`
                            }
                        }
                    }
                }
            });
        }
        
        // =====================================================================
        // SANDBOX LINKS
        // =====================================================================
        
        function setupSandboxLinks() {
            const links = [
                { id: 'profile-sandbox-link', profile: DECO_PROFILE },
                { id: 'pressure-sandbox-link', profile: DECO_PROFILE },
                { id: 'gas-sandbox-link', profile: DECO_PROFILE },
                { id: 'pp-sandbox-link', profile: DECO_PROFILE }
            ];
            
            links.forEach(({ id, profile }) => {
                const link = document.getElementById(id);
                if (link) {
                    link.href = getSandboxUrl(profile);
                }
            });
        }
        
        // =====================================================================
        // CNS/OTU TOGGLE
        // =====================================================================
        
        function setupCNSToggle() {
            const toggle = document.getElementById('cns-tracking-toggle');
            const content = document.getElementById('cns-otu-content');
            
            if (toggle && content) {
                toggle.addEventListener('change', () => {
                    content.style.display = toggle.checked ? 'block' : 'none';
                });
            }
        }
        
        // =====================================================================
        // KATEX MATH RENDERING
        // =====================================================================
        
        function renderMathFormulas() {
            if (typeof katex === 'undefined') return;
            
            // Block formulas
            document.querySelectorAll('.formula').forEach(el => {
                try {
                    katex.render(el.textContent, el, { displayMode: true });
                } catch (e) {
                    console.warn('KaTeX error:', e);
                }
            });
            
            // Inline formulas
            document.querySelectorAll('.formula-inline').forEach(el => {
                try {
                    katex.render(el.textContent, el, { displayMode: false });
                } catch (e) {
                    console.warn('KaTeX inline error:', e);
                }
            });
        }
        
        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        
        setupSandboxLinks();
        setupCNSToggle();
        renderMathFormulas();
    </script>
    
    <!-- Shared Navigation -->
    <script src="js/nav.js" type="module"></script>
</body>
</html>
