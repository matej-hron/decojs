<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dive Setup - Deco Theory</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2980b9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Deco Theory">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    
    <!-- App styles -->
    <link rel="stylesheet" href="css/styles.css?v=6">
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">ü´ß Deco Theory</a>
            <button class="nav-hamburger" aria-label="Toggle menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links">
                <!-- Generated by js/nav.js -->
            </ul>
            <span class="nav-wip-badge">üß™ Experimental</span>
        </div>
    </nav>

    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        ‚ö†Ô∏è <strong>Educational Use Only</strong> ‚Äî This tool is NOT intended for real dive planning. 
        Never use this for actual dives. Always use certified dive computers, tables, and proper training.
    </div>

    <header>
        <h1>üéØ Dive Setup</h1>
        <p class="subtitle">Configure your example dive profile to use across all learning sections</p>
    </header>

    <main>
        <!-- Introduction -->
        <section class="education-section">
            <h2>üìã About This Setup</h2>
            
            <div class="concept-card">
                <h3>Shared Dive Configuration</h3>
                <p>
                    The dive profile you configure here will be used as the example throughout the different 
                    learning sections. This allows you to explore how the same dive affects tissue loading, 
                    decompression requirements, and other aspects of dive planning.
                </p>
                <p class="hint" style="margin-top: 0.75rem;">
                    üí° <strong>Tip:</strong> Feel free to keep the default dive profile and jump straight to the 
                    <a href="#use-this-setup">learning sections below</a> to start exploring!
                </p>
            </div>
        </section>

        <!-- Current Setup Display -->
        <section class="input-section">
            <h2>üìä Dive Profile Configuration</h2>
            
            <!-- Profile Selector Cards -->
            <div class="profile-selector">
                <div class="profile-selector-header">
                    <label>Load a predefined profile:</label>
                    <button id="new-profile-btn" class="btn btn-secondary btn-small" title="Create new empty profile">+ New Profile</button>
                </div>
                <div id="profile-cards" class="profile-cards">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div id="setup-summary" class="dive-stats">
                <p>Loading dive setup...</p>
            </div>
            
            <div class="profile-controls">
                <h3>Dive Details</h3>
                
                <div class="form-group">
                    <label for="profile-name-input">Profile Name <span class="hint">(auto-generated)</span></label>
                    <input type="text" id="profile-name-input" class="form-input" value="" readonly style="background-color: var(--bg-dark); color: var(--text-light);">
                </div>
                
                <div class="form-group">
                    <label for="profile-description-input">Description</label>
                    <textarea id="profile-description-input" class="form-input form-textarea" rows="3" placeholder="Describe this dive profile..."></textarea>
                </div>

                <details class="advanced-section" id="gases-section" open>
                    <summary>‚öóÔ∏è Gases</summary>
                    <div class="gases-container">
                        <p class="hint">Define gases for your dive. First gas is used for descent and bottom. Deco gases are auto-switched during ascent at their MOD.</p>
                        
                        <div id="gases-list" class="gases-list">
                            <!-- Gas cards populated by JavaScript -->
                        </div>
                        
                        <button id="add-gas-btn" class="btn btn-secondary btn-small">+ Add Deco Gas</button>
                    </div>
                </details>

                <h3>Surface Interval (post-dive)</h3>
                <div class="surface-interval-input">
                    <label for="surface-interval-input">
                        Time at surface after final dive for off-gassing display (minutes):
                        <input type="number" id="surface-interval-input" value="60" min="0" max="720" step="10">
                    </label>
                </div>

                <!-- Quick Setup Section -->
                <details class="advanced-section" id="quick-setup-section" open>
                    <summary>‚ö° Quick Setup</summary>
                    <div class="quick-setup-inputs">
                        <p class="hint">Enter max depth and bottom time to auto-generate waypoints.<br>
                        Uses: descent 20 m/min, ascent 10 m/min, 3 min safety stop at 5m.</p>
                        <div class="quick-setup-row">
                            <div class="form-group">
                                <label for="quick-max-depth">Max Depth (m):</label>
                                <input type="number" id="quick-max-depth" class="form-input" value="30" min="1" max="100" step="1">
                            </div>
                            <div class="form-group">
                                <label for="quick-bottom-time">Bottom Time (min):</label>
                                <input type="number" id="quick-bottom-time" class="form-input" value="20" min="1" max="120" step="1">
                            </div>
                            <button id="generate-profile-btn" class="btn btn-secondary">üîÑ Generate Profile</button>
                        </div>
                    </div>
                </details>

                <!-- Dive 1 Waypoints -->
                <div id="dive1-section" class="dive-section">
                    <h3>ü§ø Dive 1 Waypoints</h3>
                    <table class="profile-table">
                        <thead>
                            <tr>
                                <th>Time (min)</th>
                                <th>Depth (m)</th>
                                <th>Gas</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="waypoints-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                    <div class="waypoint-actions">
                        <button id="add-waypoint" class="btn btn-secondary btn-small">+ Add Waypoint</button>
                        <button id="auto-gas-switch-btn" class="btn btn-secondary btn-small" title="Insert gas switch waypoints based on MOD">üîÑ Auto Gas Switches</button>
                    </div>
                </div>

                <!-- Add Repetitive Dive Button -->
                <div id="add-dive-section" class="add-dive-section">
                    <button id="add-repetitive-dive" class="btn btn-secondary">
                        ‚ûï Add Repetitive Dive
                    </button>
                    <span class="hint">Add a second dive after a surface interval</span>
                </div>

                <!-- Dive 2 Section (hidden by default) -->
                <div id="dive2-section" class="dive-section dive2-section" style="display: none;">
                    <div class="dive2-header">
                        <h3>ü§ø Dive 2 Waypoints</h3>
                        <button id="remove-dive2" class="btn btn-danger btn-small">‚úï Remove</button>
                    </div>
                    <div class="form-group surface-interval-between">
                        <label for="dive2-surface-interval">Surface Interval Before Dive 2 (minutes):</label>
                        <input type="number" id="dive2-surface-interval" class="form-input" value="60" min="1" max="720" step="5">
                    </div>
                    <table class="profile-table">
                        <thead>
                            <tr>
                                <th>Time (min)</th>
                                <th>Depth (m)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="waypoints-body-2">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                    <button id="add-waypoint-2" class="btn btn-secondary btn-small">+ Add Waypoint</button>
                </div>

                <div class="button-row">
                    <button id="reset-default" class="btn btn-secondary">Reset to Default</button>
                    <button id="export-setup" class="btn btn-secondary" title="Download setup as JSON file">üì§ Export</button>
                    <button id="import-setup" class="btn btn-secondary" title="Load setup from JSON file">üì• Import</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>

                <div id="validation-errors" class="errors"></div>

                <div class="button-row">
                    <button id="save-setup" class="btn btn-primary">‚úÖ Use Setup</button>
                </div>
                <p id="save-status" class="save-status"></p>
            </div>
        </section>

        <!-- Use This Setup Section -->
        <section class="education-section" id="use-this-setup">
            <h2>üöÄ Use This Setup</h2>
            
            <div class="topics-grid">
                <a href="pressure.html" class="topic-card available">
                    <div class="topic-icon">üìä</div>
                    <h3>Pressure</h3>
                    <p>Learn dive profile terminology and see how pressure changes with depth.</p>
                    <span class="topic-status">Explore ‚Üí</span>
                </a>

                <a href="tissue-loading.html" class="topic-card available">
                    <div class="topic-icon">ü´Å</div>
                    <h3>Tissue Loading</h3>
                    <p>See how this dive profile affects nitrogen loading in your tissue compartments.</p>
                    <span class="topic-status">Explore ‚Üí</span>
                </a>

                <div class="topic-card coming-soon">
                    <div class="topic-icon">üìà</div>
                    <h3>M-Values</h3>
                    <p>Analyze ceiling depths and surfacing limits for this profile.</p>
                    <span class="topic-status">Coming Soon</span>
                </div>

                <div class="topic-card coming-soon">
                    <div class="topic-icon">üéöÔ∏è</div>
                    <h3>Gradient Factors</h3>
                    <p>Apply different GF settings to see their effect on deco schedules.</p>
                    <span class="topic-status">Coming Soon</span>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <span class="wip-badge">Experimental</span>
        <p>
            <strong>Disclaimer:</strong> This is an educational tool only. Do not use for actual dive planning. 
            Always use certified dive computers and tables, and follow proper training.
        </p>
        <span class="version-number"></span>
    </footer>

    <!-- Dive Setup Script -->
    <script type="module">
        import { loadDiveSetup, saveDiveSetup, clearCache, formatDiveSetupSummary, getDiveSetupWaypoints, BOTTOM_GASES, DECO_GASES, BOTTOM_CYLINDERS, STAGE_CYLINDERS, getBottomGas, getDecoGas, calculateMOD, generateSimpleProfile, getGases, insertGasSwitchWaypoints, generateProfileName, getGasSwitchEvents } from './js/diveSetup.js';

        let currentSetup = null;
        let predefinedProfiles = [];
        let customProfile = null; // Store custom profile when created
        let hasDive2 = false;
        let currentGases = []; // Current gases for the dive
        let originalProfileId = null; // Track if we started from a predefined profile
        const PROFILES_PATH = 'data/dive-profiles.json';

        // DOM elements
        const profileCards = document.getElementById('profile-cards');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileDescInput = document.getElementById('profile-description-input');
        const gasesList = document.getElementById('gases-list');
        const addGasBtn = document.getElementById('add-gas-btn');
        const autoGasSwitchBtn = document.getElementById('auto-gas-switch-btn');
        const surfaceIntervalInput = document.getElementById('surface-interval-input');
        const waypointsBody = document.getElementById('waypoints-body');
        const addWaypointBtn = document.getElementById('add-waypoint');
        const resetDefaultBtn = document.getElementById('reset-default');
        const saveSetupBtn = document.getElementById('save-setup');
        const saveStatus = document.getElementById('save-status');
        const validationErrors = document.getElementById('validation-errors');
        const setupSummary = document.getElementById('setup-summary');
        
        // Dive 2 DOM elements
        const dive2Section = document.getElementById('dive2-section');
        const addDiveSection = document.getElementById('add-dive-section');
        const addRepetitiveDiveBtn = document.getElementById('add-repetitive-dive');
        const removeDive2Btn = document.getElementById('remove-dive2');
        const waypointsBody2 = document.getElementById('waypoints-body-2');
        const addWaypoint2Btn = document.getElementById('add-waypoint-2');
        const dive2SurfaceIntervalInput = document.getElementById('dive2-surface-interval');
        
        // Quick setup DOM elements
        const quickMaxDepthInput = document.getElementById('quick-max-depth');
        const quickBottomTimeInput = document.getElementById('quick-bottom-time');
        const generateProfileBtn = document.getElementById('generate-profile-btn');
        
        // New profile button
        const newProfileBtn = document.getElementById('new-profile-btn');

        // ============================================================================
        // MULTI-GAS MANAGEMENT
        // ============================================================================

        // Render gas cards
        function renderGasCards() {
            gasesList.innerHTML = '';
            
            currentGases.forEach((gas, index) => {
                const card = document.createElement('div');
                card.className = 'gas-card';
                card.dataset.gasIndex = index;
                
                const mod14 = calculateMOD(gas.o2, 1.4);
                const mod16 = calculateMOD(gas.o2, 1.6);
                const isBottomGas = index === 0;
                
                // Use appropriate gas list for bottom vs deco gases
                const gasOptions = isBottomGas ? BOTTOM_GASES : DECO_GASES;
                const cylinderOptions = isBottomGas ? BOTTOM_CYLINDERS : STAGE_CYLINDERS;
                
                card.innerHTML = `
                    <div class="gas-card-header">
                        <span class="gas-card-label">${isBottomGas ? 'ü´ß Bottom Gas' : 'üîÑ Deco Gas ' + index}</span>
                        ${!isBottomGas ? '<button class="gas-card-remove" title="Remove gas">√ó</button>' : ''}
                    </div>
                    <div class="gas-card-content">
                        <div class="gas-card-row">
                            <label>Gas:</label>
                            <select class="gas-preset-select form-select">
                                ${gasOptions.map(g => 
                                    `<option value="${g.id}" ${g.o2 === gas.o2 && g.he === gas.he ? 'selected' : ''}>${g.name}</option>`
                                ).join('')}
                                <option value="custom">‚úèÔ∏è Custom...</option>
                            </select>
                        </div>
                        <div class="gas-card-row gas-custom-inputs" style="display: none;">
                            <label>O‚ÇÇ:</label>
                            <input type="number" class="gas-o2-input" min="5" max="100" step="1" value="${Math.round(gas.o2 * 100)}">%
                            <label>He:</label>
                            <input type="number" class="gas-he-input" min="0" max="95" step="1" value="${Math.round(gas.he * 100)}">%
                        </div>
                        <div class="gas-card-row">
                            <label>Tank:</label>
                            <select class="gas-cylinder-select form-select">
                                ${cylinderOptions.map(c => 
                                    `<option value="${c.value}" ${c.value === gas.cylinderVolume ? 'selected' : ''}>${c.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="gas-card-row gas-mod">
                            <span class="hint">MOD: ${mod14}m (deco: ${mod16}m)</span>
                        </div>
                    </div>
                `;
                
                // Wire up events
                const presetSelect = card.querySelector('.gas-preset-select');
                const customInputs = card.querySelector('.gas-custom-inputs');
                const o2Input = card.querySelector('.gas-o2-input');
                const heInput = card.querySelector('.gas-he-input');
                const cylinderSelect = card.querySelector('.gas-cylinder-select');
                const modDisplay = card.querySelector('.gas-mod .hint');
                
                // Check if current gas matches a preset in the appropriate list
                const matchingPreset = gasOptions.find(g => 
                    Math.abs(g.o2 - gas.o2) < 0.01 && Math.abs(g.he - gas.he) < 0.01
                );
                if (!matchingPreset) {
                    presetSelect.value = 'custom';
                    customInputs.style.display = 'flex';
                }
                
                presetSelect.addEventListener('change', () => {
                    if (presetSelect.value === 'custom') {
                        customInputs.style.display = 'flex';
                    } else {
                        customInputs.style.display = 'none';
                        const preset = isBottomGas ? getBottomGas(presetSelect.value) : getDecoGas(presetSelect.value);
                        if (preset) {
                            currentGases[index] = { 
                                ...currentGases[index],
                                name: preset.name,
                                o2: preset.o2, 
                                n2: preset.n2, 
                                he: preset.he 
                            };
                            o2Input.value = Math.round(preset.o2 * 100);
                            heInput.value = Math.round(preset.he * 100);
                            updateGasModDisplay(modDisplay, preset.o2);
                            updateWaypointGasDropdowns();
                        }
                    }
                });
                
                cylinderSelect.addEventListener('change', () => {
                    currentGases[index].cylinderVolume = parseFloat(cylinderSelect.value);
                    // Start pressure is always 200 bar by default
                    currentGases[index].startPressure = 200;
                });
                
                o2Input.addEventListener('input', () => {
                    const o2 = (parseFloat(o2Input.value) || 21) / 100;
                    const he = (parseFloat(heInput.value) || 0) / 100;
                    const n2 = Math.max(0, 1 - o2 - he);
                    currentGases[index] = { 
                        ...currentGases[index],
                        name: `Custom ${Math.round(o2 * 100)}/${Math.round(he * 100)}`,
                        o2, n2, he 
                    };
                    updateGasModDisplay(modDisplay, o2);
                    updateWaypointGasDropdowns();
                });
                
                heInput.addEventListener('input', () => {
                    const o2 = (parseFloat(o2Input.value) || 21) / 100;
                    const he = (parseFloat(heInput.value) || 0) / 100;
                    const n2 = Math.max(0, 1 - o2 - he);
                    currentGases[index] = { 
                        ...currentGases[index],
                        name: `Custom ${Math.round(o2 * 100)}/${Math.round(he * 100)}`,
                        o2, n2, he 
                    };
                    updateGasModDisplay(modDisplay, o2);
                    updateWaypointGasDropdowns();
                });
                
                if (!isBottomGas) {
                    card.querySelector('.gas-card-remove').addEventListener('click', () => {
                        currentGases.splice(index, 1);
                        renderGasCards();
                        updateWaypointGasDropdowns();
                    });
                }
                
                gasesList.appendChild(card);
            });
        }

        function updateGasModDisplay(modDisplay, o2Fraction) {
            const mod14 = calculateMOD(o2Fraction, 1.4);
            const mod16 = calculateMOD(o2Fraction, 1.6);
            modDisplay.textContent = `MOD: ${mod14}m (deco: ${mod16}m)`;
        }

        // Add deco gas button handler
        addGasBtn.addEventListener('click', () => {
            if (currentGases.length >= 4) {
                alert('Maximum 4 gases allowed');
                return;
            }
            
            // Add EAN50 as default deco gas with default stage cylinder
            const ean50 = getDecoGas('ean50');
            const defaultCylinder = STAGE_CYLINDERS[2]; // 7L AL50
            currentGases.push({
                id: `deco${currentGases.length}`,
                name: ean50.name,
                o2: ean50.o2,
                n2: ean50.n2,
                he: ean50.he,
                cylinderVolume: defaultCylinder.value,
                startPressure: 200
            });
            renderGasCards();
            updateWaypointGasDropdowns();
        });

        // Auto gas switch button handler
        autoGasSwitchBtn.addEventListener('click', () => {
            if (currentGases.length < 2) {
                alert('Add at least one deco gas first');
                return;
            }
            
            const waypoints = readWaypointsFromTable(waypointsBody);
            const newWaypoints = insertGasSwitchWaypoints(waypoints, currentGases);
            loadWaypointsToTable(newWaypoints, waypointsBody);
            updateSummary();
            
            // Count gas switches configured (from getGasSwitchEvents)
            const gasSwitchEvents = getGasSwitchEvents(newWaypoints, currentGases);
            const insertedCount = newWaypoints.length - waypoints.length;
            
            if (gasSwitchEvents.length > 0) {
                const switchInfo = gasSwitchEvents.map(e => `${e.toGas?.name} at ${e.depth}m`).join(', ');
                saveStatus.textContent = `‚úì Configured ${gasSwitchEvents.length} gas switch(es): ${switchInfo}. Click Save to apply!`;
            } else {
                saveStatus.textContent = `No gas switches configured (deco gases may not be usable in this profile)`;
            }
            saveStatus.className = 'save-status success';
            setTimeout(() => { saveStatus.textContent = ''; }, 5000);
        });

        // Update gas dropdowns in waypoint rows
        function updateWaypointGasDropdowns() {
            document.querySelectorAll('.gas-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = currentGases.map(gas => 
                    `<option value="${gas.id}" ${gas.id === currentValue ? 'selected' : ''}>${gas.name}</option>`
                ).join('');
            });
        }

        // Load predefined profiles
        async function loadPredefinedProfiles() {
            try {
                const response = await fetch(PROFILES_PATH);
                const data = await response.json();
                predefinedProfiles = data.profiles || [];
                
                renderProfileCards();
                
                return data.defaultProfileId;
            } catch (error) {
                console.error('Error loading predefined profiles:', error);
                return null;
            }
        }

        // Render profile cards
        function renderProfileCards(selectedId = null) {
            profileCards.innerHTML = '';
            
            // Add predefined profiles
            predefinedProfiles.forEach(profile => {
                const card = createProfileCard(profile, selectedId === profile.id);
                profileCards.appendChild(card);
            });
            
            // Add custom profile if exists
            if (customProfile) {
                const card = createProfileCard(customProfile, selectedId === 'custom');
                profileCards.appendChild(card);
            }
        }

        // Create a profile card element
        function createProfileCard(profile, isSelected = false) {
            const card = document.createElement('div');
            card.className = `profile-card${isSelected ? ' selected' : ''}`;
            card.dataset.profileId = profile.id;
            
            // Get dive stats
            const waypoints = profile.dives ? 
                profile.dives[0].waypoints : profile.waypoints;
            const maxDepth = Math.max(...waypoints.map(wp => wp.depth));
            const totalTime = waypoints[waypoints.length - 1]?.time || 0;
            const diveCount = profile.dives?.length || 1;
            
            const isCustom = profile.id === 'custom';
            
            card.innerHTML = `
                <div class="profile-card-header">
                    <span class="profile-card-name">${profile.name}</span>
                    ${isCustom ? '<span class="profile-card-badge">Custom</span>' : ''}
                    ${isCustom ? '<button class="profile-card-delete" title="Delete custom profile">√ó</button>' : ''}
                </div>
                <div class="profile-card-stats">
                    <span>${maxDepth}m</span>
                    <span>${totalTime} min</span>
                    ${diveCount > 1 ? `<span>${diveCount} dives</span>` : ''}
                </div>
            `;
            
            card.addEventListener('click', (e) => {
                // Don't select if clicking delete button
                if (!e.target.classList.contains('profile-card-delete')) {
                    selectProfile(profile.id);
                }
            });
            
            // Add delete handler for custom profiles
            if (isCustom) {
                const deleteBtn = card.querySelector('.profile-card-delete');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCustomProfile();
                });
            }
            
            return card;
        }

        // Delete custom profile
        function deleteCustomProfile() {
            if (!confirm('Delete this custom profile?')) return;
            
            customProfile = null;
            localStorage.removeItem('diveSetup');
            clearCache();
            
            // Switch to default profile
            const defaultProfile = predefinedProfiles.find(p => p.id === 'deco-dive') || predefinedProfiles[0];
            if (defaultProfile) {
                currentSetup = { ...defaultProfile };
                populateForm(defaultProfile);
                saveDiveSetup(currentSetup);
                renderProfileCards(defaultProfile.id);
            } else {
                renderProfileCards(null);
            }
            
            saveStatus.textContent = 'Custom profile deleted.';
            saveStatus.className = 'save-status';
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        }

        // Handle profile selection
        function selectProfile(profileId) {
            let profile;
            
            if (profileId === 'custom' && customProfile) {
                profile = customProfile;
            } else {
                profile = predefinedProfiles.find(p => p.id === profileId);
            }
            
            if (profile) {
                currentSetup = { ...profile };
                populateForm(profile);
                
                // Auto-save the selected profile
                saveDiveSetup(currentSetup);
                clearCache();
                
                // Update card selection
                renderProfileCards(profileId);
                
                saveStatus.textContent = `‚úì Now using "${profile.name}"`;
                saveStatus.className = 'save-status success';
                setTimeout(() => { saveStatus.textContent = ''; }, 3000);
            }
        }

        // Shift time for a waypoint and all subsequent waypoints
        function shiftWaypointTimes(row, delta, targetBody = waypointsBody) {
            const rows = Array.from(targetBody.querySelectorAll('tr'));
            const rowIndex = rows.indexOf(row);
            
            // Don't allow shifting the first waypoint (must stay at time 0)
            if (rowIndex === 0) {
                alert('First waypoint must remain at time 0');
                return;
            }
            
            // Shift this row and all subsequent rows
            for (let i = rowIndex; i < rows.length; i++) {
                const timeInput = rows[i].querySelector('.time-input');
                if (timeInput) {
                    const currentTime = parseFloat(timeInput.value) || 0;
                    const newTime = Math.max(0, currentTime + delta);
                    timeInput.value = newTime;
                }
            }
            
            updateSummary();
        }

        // Insert a waypoint after a specific row
        function insertWaypointAfter(afterRow, targetBody = waypointsBody) {
            const rows = Array.from(targetBody.querySelectorAll('tr'));
            const rowIndex = rows.indexOf(afterRow);
            
            // Get times from current and next row to calculate midpoint
            const currentTime = parseFloat(afterRow.querySelector('.time-input').value) || 0;
            const currentDepth = parseFloat(afterRow.querySelector('.depth-input').value) || 0;
            const currentGasId = afterRow.querySelector('.gas-select')?.value || currentGases[0]?.id || 'bottom';
            
            let nextTime = currentTime + 2; // Default: 2 minutes after
            let nextDepth = currentDepth;
            
            if (rowIndex < rows.length - 1) {
                const nextRow = rows[rowIndex + 1];
                nextTime = parseFloat(nextRow.querySelector('.time-input').value) || currentTime + 2;
                nextDepth = parseFloat(nextRow.querySelector('.depth-input').value) || currentDepth;
            }
            
            // Create midpoint
            const midTime = Math.round((currentTime + nextTime) / 2);
            const midDepth = Math.round((currentDepth + nextDepth) / 2);
            
            // Create new row and insert after current
            const newRow = createWaypointRow(midTime, midDepth, currentGasId, targetBody);
            afterRow.after(newRow);
            
            updateSummary();
        }

        // Create a waypoint row element (without adding to DOM)
        function createWaypointRow(time = '', depth = '', gasId = '', targetBody = waypointsBody) {
            const row = document.createElement('tr');
            const gasOptions = currentGases.map(gas => 
                `<option value="${gas.id}" ${gas.id === gasId ? 'selected' : ''}>${gas.name}</option>`
            ).join('');
            
            row.innerHTML = `
                <td><input type="number" class="time-input" value="${time}" min="0" step="1" placeholder="0"></td>
                <td><input type="number" class="depth-input" value="${depth}" min="0" step="1" placeholder="0"></td>
                <td><select class="gas-select form-select-small">${gasOptions}</select></td>
                <td class="waypoint-actions-cell">
                    <button class="btn btn-icon btn-small time-shift-down" title="Shift this and following waypoints -1 min">‚àí</button>
                    <button class="btn btn-icon btn-small time-shift-up" title="Shift this and following waypoints +1 min">+</button>
                    <button class="btn btn-icon btn-small insert-waypoint" title="Insert waypoint after this">‚äï</button>
                    <button class="btn btn-danger btn-small remove-row" title="Remove waypoint">√ó</button>
                </td>
            `;
            
            // Time shift handlers
            row.querySelector('.time-shift-down').addEventListener('click', () => {
                shiftWaypointTimes(row, -1, targetBody);
            });
            row.querySelector('.time-shift-up').addEventListener('click', () => {
                shiftWaypointTimes(row, 1, targetBody);
            });
            
            // Insert waypoint handler
            row.querySelector('.insert-waypoint').addEventListener('click', () => {
                insertWaypointAfter(row, targetBody);
            });
            
            // Remove row handler
            row.querySelector('.remove-row').addEventListener('click', () => {
                if (targetBody.children.length > 2) {
                    row.remove();
                    updateSummary();
                } else {
                    alert('Profile must have at least 2 waypoints');
                }
            });
            
            return row;
        }

        // Add waypoint row to a specific table (at end)
        function addWaypointRow(time = '', depth = '', gasId = '', targetBody = waypointsBody) {
            const row = createWaypointRow(time, depth, gasId, targetBody);
            targetBody.appendChild(row);
        }

        // Load waypoints into table
        function loadWaypointsToTable(waypoints, targetBody = waypointsBody) {
            targetBody.innerHTML = '';
            waypoints.forEach(wp => addWaypointRow(wp.time, wp.depth, wp.gasId || currentGases[0]?.id || 'bottom', targetBody));
        }

        // Read waypoints from table
        function readWaypointsFromTable(targetBody = waypointsBody) {
            const rows = targetBody.querySelectorAll('tr');
            const waypoints = [];
            rows.forEach(row => {
                const timeInput = row.querySelector('.time-input');
                const depthInput = row.querySelector('.depth-input');
                const gasSelect = row.querySelector('.gas-select');
                if (timeInput && depthInput) {
                    waypoints.push({
                        time: parseFloat(timeInput.value) || 0,
                        depth: parseFloat(depthInput.value) || 0,
                        gasId: gasSelect?.value || currentGases[0]?.id || 'bottom'
                    });
                }
            });
            return waypoints;
        }

        // Build setup object from form
        function buildSetupFromForm() {
            // Always use dives format
            let dives;
            
            if (hasDive2) {
                dives = [
                    { waypoints: readWaypointsFromTable(waypointsBody) },
                    { 
                        surfaceIntervalBefore: parseFloat(dive2SurfaceIntervalInput.value) || 60,
                        waypoints: readWaypointsFromTable(waypointsBody2) 
                    }
                ];
            } else {
                dives = [{ waypoints: readWaypointsFromTable(waypointsBody) }];
            }
            
            // Get all waypoints for stats
            const allWaypoints = dives.flatMap(d => d.waypoints);
            
            // Calculate max depth and generate name from setup data
            const maxDepth = Math.max(...allWaypoints.map(wp => wp.depth), 0);
            const gasNames = currentGases.map(g => g.name).join(' + ');
            const generatedName = `${maxDepth}m ${gasNames}`;
            
            return {
                id: 'custom', // Always custom when modified
                name: generatedName, // Auto-generated descriptive name
                description: profileDescInput.value || '',
                gases: currentGases, // Gases with cylinder info per gas
                dives: dives, // Always use dives format
                surfaceInterval: parseFloat(surfaceIntervalInput.value) || 60,
                units: currentSetup?.units || { depth: 'meters', time: 'minutes', pressure: 'bar' }
            };
        }

        // Validate a single dive's waypoints
        function validateWaypoints(waypoints, diveLabel = '') {
            const errors = [];
            const prefix = diveLabel ? `${diveLabel}: ` : '';
            
            if (waypoints.length < 2) {
                errors.push(`${prefix}Must have at least 2 waypoints`);
            }
            if (waypoints.length > 0 && waypoints[0].time !== 0) {
                errors.push(`${prefix}First waypoint must be at time 0`);
            }
            if (waypoints.length > 0 && waypoints[0].depth !== 0) {
                errors.push(`${prefix}First waypoint should be at surface (0m)`);
            }
            // Check time is ascending
            for (let i = 1; i < waypoints.length; i++) {
                if (waypoints[i].time <= waypoints[i-1].time) {
                    errors.push(`${prefix}Waypoint ${i+1}: Time must be greater than previous`);
                }
            }
            return errors;
        }

        // Validate setup
        function validateSetup(setup) {
            const errors = [];
            
            // Validate dives
            if (setup.dives && setup.dives.length > 0) {
                setup.dives.forEach((dive, i) => {
                    errors.push(...validateWaypoints(dive.waypoints, `Dive ${i+1}`));
                });
            } else {
                errors.push('No dives defined');
            }
            
            // Check each gas mix totals 100%
            if (setup.gases && setup.gases.length > 0) {
                setup.gases.forEach((gas, i) => {
                    const total = gas.o2 + gas.n2 + gas.he;
                    if (Math.abs(total - 1) > 0.01) {
                        errors.push(`Gas ${i + 1} (${gas.name}) must total 100%`);
                    }
                });
            } else {
                errors.push('No gases defined');
            }
            return errors;
        }

        // Update profile name based on current setup data
        function updateProfileName() {
            const waypoints = hasDive2 
                ? [...readWaypointsFromTable(waypointsBody), ...readWaypointsFromTable(waypointsBody2)]
                : readWaypointsFromTable(waypointsBody);
            const maxDepth = Math.max(...waypoints.map(wp => wp.depth), 0);
            const gasNames = currentGases.map(g => g.name).join(' + ');
            profileNameInput.value = `${maxDepth}m ${gasNames}`;
        }

        // Update summary display
        function updateSummary() {
            const setup = buildSetupFromForm();
            setupSummary.innerHTML = `<p><strong>${formatDiveSetupSummary(setup)}</strong></p>`;
            // Also update the auto-generated profile name
            updateProfileName();
        }

        // Show/hide dive 2 section
        function showDive2(show) {
            hasDive2 = show;
            dive2Section.style.display = show ? 'block' : 'none';
            addDiveSection.style.display = show ? 'none' : 'block';
            updateSummary();
        }

        // Populate form from setup object
        function populateForm(setup) {
            profileDescInput.value = setup.description || '';
            
            // Load gases (includes cylinder info per gas)
            currentGases = getGases(setup);
            renderGasCards();
            
            surfaceIntervalInput.value = setup.surfaceInterval || 60;
            
            // Handle multi-dive vs single dive format
            if (setup.dives && setup.dives.length > 0) {
                // Multi-dive format
                loadWaypointsToTable(setup.dives[0].waypoints || [], waypointsBody);
                
                if (setup.dives.length > 1) {
                    const dive2 = setup.dives[1];
                    dive2SurfaceIntervalInput.value = dive2.surfaceIntervalBefore || 60;
                    loadWaypointsToTable(dive2.waypoints || [], waypointsBody2);
                    showDive2(true);
                } else {
                    showDive2(false);
                }
            } else {
                // Legacy single waypoints format
                loadWaypointsToTable(setup.waypoints || [], waypointsBody);
                showDive2(false);
            }
            
            updateSummary();
        }

        // Save setup
        saveSetupBtn.addEventListener('click', () => {
            const setup = buildSetupFromForm();
            const errors = validateSetup(setup);
            
            if (errors.length > 0) {
                validationErrors.innerHTML = errors.map(e => `<div>${e}</div>`).join('');
                return;
            }
            
            validationErrors.innerHTML = '';
            saveDiveSetup(setup);
            clearCache(); // Clear cache so other pages load fresh
            currentSetup = setup;
            
            // Check if this matches a predefined profile
            const matchingPredefined = predefinedProfiles.find(p => p.id === setup.id);
            
            if (!matchingPredefined) {
                // This is a custom profile - update or create custom card
                customProfile = { ...setup, id: 'custom' };
                renderProfileCards('custom');
            }
            
            updateSummary();
            
            saveStatus.textContent = '‚úì Setup saved! Other sections will use this profile.';
            saveStatus.className = 'save-status success';
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        });

        // Add waypoint to dive 1
        addWaypointBtn.addEventListener('click', () => {
            addWaypointRow('', '', waypointsBody);
            updateSummary();
        });

        // Add waypoint to dive 2
        addWaypoint2Btn.addEventListener('click', () => {
            addWaypointRow('', '', waypointsBody2);
            updateSummary();
        });

        // Create new empty profile
        newProfileBtn.addEventListener('click', () => {
            // Create a new empty profile with basic waypoints
            const newProfile = {
                id: 'custom',
                name: 'New Profile',
                description: '',
                gases: [{
                    id: 'bottom',
                    name: 'Air',
                    o2: 0.21,
                    n2: 0.79,
                    he: 0,
                    cylinderVolume: 12,
                    startPressure: 200
                }],
                dives: [{
                    waypoints: [
                        { time: 0, depth: 0 },
                        { time: 2, depth: 20 },
                        { time: 20, depth: 20 },
                        { time: 22, depth: 5 },
                        { time: 25, depth: 5 },
                        { time: 26, depth: 0 }
                    ]
                }],
                surfaceInterval: 60,
                units: { depth: 'meters', time: 'minutes', pressure: 'bar' }
            };
            
            currentSetup = newProfile;
            customProfile = { ...newProfile };
            populateForm(newProfile);
            renderProfileCards('custom');
            
            saveStatus.textContent = '‚úì Created new profile. Customize and save!';
            saveStatus.className = 'save-status success';
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        });

        // Add repetitive dive
        addRepetitiveDiveBtn.addEventListener('click', () => {
            // Add default waypoints for dive 2
            loadWaypointsToTable([
                { time: 0, depth: 0 },
                { time: 2, depth: 18 },
                { time: 25, depth: 18 },
                { time: 28, depth: 5 },
                { time: 31, depth: 5 },
                { time: 33, depth: 0 }
            ], waypointsBody2);
            dive2SurfaceIntervalInput.value = 60;
            showDive2(true);
        });

        // Generate profile from quick setup
        generateProfileBtn.addEventListener('click', () => {
            const maxDepth = parseFloat(quickMaxDepthInput.value) || 30;
            const bottomTime = parseFloat(quickBottomTimeInput.value) || 20;
            
            if (maxDepth < 1 || maxDepth > 100) {
                alert('Max depth must be between 1 and 100 meters');
                return;
            }
            if (bottomTime < 1 || bottomTime > 120) {
                alert('Bottom time must be between 1 and 120 minutes');
                return;
            }
            
            const waypoints = generateSimpleProfile(maxDepth, bottomTime);
            loadWaypointsToTable(waypoints, waypointsBody);
            
            // Update profile name to reflect the quick setup
            profileNameInput.value = `${maxDepth}m for ${bottomTime}min`;
            profileDescInput.value = `Quick setup: ${maxDepth}m max depth, ${bottomTime}min bottom time. Auto-generated with 20 m/min descent, 10 m/min ascent, 3 min safety stop at 5m.`;
            
            updateSummary();
            
            // Show feedback
            saveStatus.textContent = `‚úì Generated profile: ${maxDepth}m for ${bottomTime}min`;
            saveStatus.className = 'save-status success';
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        });

        // Remove dive 2
        removeDive2Btn.addEventListener('click', () => {
            showDive2(false);
            waypointsBody2.innerHTML = '';
        });

        // Update summary when dive 2 surface interval changes
        dive2SurfaceIntervalInput.addEventListener('input', updateSummary);

        // Reset to default
        resetDefaultBtn.addEventListener('click', async () => {
            if (confirm('Reset to default dive profile? Your changes will be lost.')) {
                localStorage.removeItem('diveSetup');
                clearCache();
                customProfile = null; // Clear custom profile
                
                // Load the default from predefined profiles
                const defaultProfile = predefinedProfiles.find(p => p.id === 'deco-dive') || predefinedProfiles[0];
                if (defaultProfile) {
                    currentSetup = { ...defaultProfile };
                    populateForm(defaultProfile);
                    renderProfileCards(defaultProfile.id);
                }
                
                saveStatus.textContent = 'Reset to default profile.';
                saveStatus.className = 'save-status';
                setTimeout(() => { saveStatus.textContent = ''; }, 3000);
            }
        });

        // Export setup to JSON file
        const exportSetupBtn = document.getElementById('export-setup');
        exportSetupBtn.addEventListener('click', () => {
            // Build the setup object from current form state
            const setupToExport = buildSetupFromForm();
            
            // Create a clean export (remove internal fields)
            const exportData = {
                ...setupToExport,
                exportedAt: new Date().toISOString(),
                exportVersion: '1.0'
            };
            
            // Create and download JSON file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = (setupToExport.name || 'dive-setup').replace(/[^a-z0-9]/gi, '-').toLowerCase();
            a.download = `${filename}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            saveStatus.textContent = 'Setup exported successfully!';
            saveStatus.className = 'save-status success';
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        });

        // Import setup from JSON file
        const importSetupBtn = document.getElementById('import-setup');
        const importFileInput = document.getElementById('import-file-input');
        
        importSetupBtn.addEventListener('click', () => {
            importFileInput.click();
        });
        
        importFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedSetup = JSON.parse(text);
                
                // Validate imported data has required fields
                if (!importedSetup.dives && !importedSetup.waypoints) {
                    throw new Error('Invalid dive setup: missing dives or waypoints');
                }
                
                // Clean up import metadata
                delete importedSetup.exportedAt;
                delete importedSetup.exportVersion;
                
                // Mark as custom profile since it's imported
                importedSetup.id = 'custom';
                
                // Update current setup and UI
                currentSetup = importedSetup;
                customProfile = { ...importedSetup };
                populateForm(importedSetup);
                renderProfileCards('custom');
                
                saveStatus.textContent = `Imported: ${importedSetup.name || 'Dive Setup'}`;
                saveStatus.className = 'save-status success';
                setTimeout(() => { saveStatus.textContent = ''; }, 3000);
                
            } catch (error) {
                console.error('Import failed:', error);
                saveStatus.textContent = 'Import failed: ' + error.message;
                saveStatus.className = 'save-status error';
                setTimeout(() => { saveStatus.textContent = ''; }, 5000);
            }
            
            // Reset file input so same file can be imported again
            importFileInput.value = '';
        });

        // Update summary on input changes
        [profileNameInput, profileDescInput, surfaceIntervalInput].forEach(el => {
            el.addEventListener('input', updateSummary);
        });

        async function init() {
            // Load predefined profiles first
            const defaultProfileId = await loadPredefinedProfiles();
            
            // Try to load saved setup from localStorage
            currentSetup = await loadDiveSetup();
            
            // Check if setup has valid waypoints (either format)
            const hasWaypoints = currentSetup && (
                (currentSetup.waypoints && currentSetup.waypoints.length > 0) ||
                (currentSetup.dives && currentSetup.dives.length > 0)
            );
            
            // If no saved setup, use default from predefined profiles
            if (!hasWaypoints) {
                const defaultProfile = predefinedProfiles.find(p => p.id === defaultProfileId) || predefinedProfiles[0];
                if (defaultProfile) {
                    currentSetup = { ...defaultProfile };
                }
            } else {
                // Check if saved setup is a custom profile (not matching predefined)
                const matchingPredefined = predefinedProfiles.find(p => p.id === currentSetup.id);
                if (!matchingPredefined) {
                    customProfile = { ...currentSetup, id: 'custom' };
                }
            }
            
            populateForm(currentSetup);
            
            // Highlight the current profile card
            const currentId = currentSetup.id && predefinedProfiles.find(p => p.id === currentSetup.id) 
                ? currentSetup.id 
                : (customProfile ? 'custom' : null);
            renderProfileCards(currentId);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Shared Navigation -->
    <script src="js/nav.js" type="module"></script>
</body>
</html>